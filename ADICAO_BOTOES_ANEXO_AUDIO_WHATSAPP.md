-- Descri√ß√£o: Adi√ß√£o de bot√µes de anexo de arquivo/imagem e grava√ß√£o de √°udio no menu WhatsApp
-- Data: 2025-10-11
-- Autor: Sistema MedX

# üìéüé§ Adi√ß√£o: Bot√µes de Anexo e √Åudio no WhatsApp

## üìã Vis√£o Geral

Foram adicionados dois novos bot√µes na barra de mensagens do WhatsApp para futura implementa√ß√£o de:

1. **üìé Anexar Arquivo/Imagem** - Upload de documentos, imagens, PDFs, etc.
2. **üé§ Gravar √Åudio** - Grava√ß√£o de mensagens de voz

**Status Atual:** Bot√µes visuais criados, funcionalidade a ser implementada posteriormente.

---

## üé® Interface Implementada

### Layout da Barra de Mensagens

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [üìé]  [Input de texto...]  [üé§]  [üì§]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Ordem dos elementos:**
1. **Bot√£o Anexar** (üìé) - Esquerda
2. **Input de Texto** - Centro (flex-1)
3. **Bot√£o √Åudio** (üé§) - Antes do enviar
4. **Bot√£o Enviar** (üì§) - Direita

---

## üîß Implementa√ß√£o T√©cnica

### 1. Imports Adicionados

```typescript
import { Paperclip, Mic } from 'lucide-react';
```

### 2. Handlers Criados

#### Handler de Anexo

```typescript
const handleAttachFile = () => {
  console.log('[WhatsApp] üìé Bot√£o de anexar arquivo clicado');
  toast.info('Funcionalidade de anexo ser√° implementada em breve');
  // TODO: Implementar upload de arquivo/imagem
};
```

**Funcionalidades futuras:**
- Abrir dialog de sele√ß√£o de arquivo
- Suportar imagens (JPG, PNG, GIF, WebP)
- Suportar documentos (PDF, DOC, XLS, etc.)
- Preview antes do envio
- Upload para Supabase Storage
- Enviar URL via API de WhatsApp

#### Handler de √Åudio

```typescript
const handleRecordAudio = () => {
  console.log('[WhatsApp] üé§ Bot√£o de gravar √°udio clicado');
  toast.info('Funcionalidade de √°udio ser√° implementada em breve');
  // TODO: Implementar grava√ß√£o de √°udio
};
```

**Funcionalidades futuras:**
- Iniciar grava√ß√£o ao clicar
- Mostrar timer de grava√ß√£o
- Bot√£o para parar grava√ß√£o
- Preview do √°udio gravado
- Upload para Supabase Storage
- Enviar URL via API de WhatsApp

### 3. Componentes da Interface

#### Bot√£o de Anexar

```tsx
<TooltipProvider delayDuration={200}>
  <Tooltip>
    <TooltipTrigger asChild>
      <Button
        variant="ghost"
        size="icon"
        onClick={handleAttachFile}
        disabled={!selectedSessionId || sending}
        className="shrink-0 hover:bg-accent"
      >
        <Paperclip className="h-4 w-4" />
      </Button>
    </TooltipTrigger>
    <TooltipContent side="top">
      <p>Anexar arquivo ou imagem</p>
    </TooltipContent>
  </Tooltip>
</TooltipProvider>
```

**Caracter√≠sticas:**
- ‚úÖ √çcone: `Paperclip` (clipe de papel)
- ‚úÖ Tooltip: "Anexar arquivo ou imagem"
- ‚úÖ Variante: `ghost` (transparente)
- ‚úÖ Hover: Fundo cinza claro
- ‚úÖ Desabilitado quando: Sem conversa selecionada OU enviando mensagem

#### Bot√£o de √Åudio

```tsx
<TooltipProvider delayDuration={200}>
  <Tooltip>
    <TooltipTrigger asChild>
      <Button
        variant="ghost"
        size="icon"
        onClick={handleRecordAudio}
        disabled={!selectedSessionId || sending}
        className="shrink-0 hover:bg-accent"
      >
        <Mic className="h-4 w-4" />
      </Button>
    </TooltipTrigger>
    <TooltipContent side="top">
      <p>Gravar mensagem de √°udio</p>
    </TooltipContent>
  </Tooltip>
</TooltipProvider>
```

**Caracter√≠sticas:**
- ‚úÖ √çcone: `Mic` (microfone)
- ‚úÖ Tooltip: "Gravar mensagem de √°udio"
- ‚úÖ Variante: `ghost` (transparente)
- ‚úÖ Hover: Fundo cinza claro
- ‚úÖ Desabilitado quando: Sem conversa selecionada OU enviando mensagem

---

## üéØ Estados dos Bot√µes

| Estado | Condi√ß√£o | Visual |
|--------|----------|--------|
| **Normal** | Conversa selecionada + n√£o enviando | Cinza claro, clic√°vel |
| **Hover** | Mouse sobre o bot√£o | Fundo cinza mais escuro |
| **Desabilitado** | Sem conversa OU enviando | Cinza claro, n√£o clic√°vel |
| **Ativo (futuro)** | Gravando √°udio | Vermelho pulsante |

---

## üì± Comportamento Atual

### Ao Clicar no Bot√£o de Anexo (üìé)

1. **Log no console:**
   ```
   [WhatsApp] üìé Bot√£o de anexar arquivo clicado
   ```

2. **Toast informativo:**
   ```
   ‚ÑπÔ∏è Funcionalidade de anexo ser√° implementada em breve
   ```

### Ao Clicar no Bot√£o de √Åudio (üé§)

1. **Log no console:**
   ```
   [WhatsApp] üé§ Bot√£o de gravar √°udio clicado
   ```

2. **Toast informativo:**
   ```
   ‚ÑπÔ∏è Funcionalidade de √°udio ser√° implementada em breve
   ```

---

## üöÄ Pr√≥ximos Passos - Implementa√ß√£o de Anexo

### 1. Criar Input de Arquivo Oculto

```tsx
const fileInputRef = useRef<HTMLInputElement>(null);

const handleAttachFile = () => {
  fileInputRef.current?.click();
};

const handleFileSelected = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  console.log('Arquivo selecionado:', file.name, file.type, file.size);
  
  // TODO: Implementar upload e envio
};

// No JSX, adicionar input oculto:
<input
  ref={fileInputRef}
  type="file"
  accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
  onChange={handleFileSelected}
  style={{ display: 'none' }}
/>
```

### 2. Upload para Supabase Storage

```typescript
const uploadFile = async (file: File) => {
  const fileName = `${Date.now()}_${file.name}`;
  const filePath = `whatsapp/${selectedSessionId}/${fileName}`;

  const { data, error } = await supabase.storage
    .from('attachments')
    .upload(filePath, file);

  if (error) throw error;

  // Obter URL p√∫blica
  const { data: publicUrl } = supabase.storage
    .from('attachments')
    .getPublicUrl(filePath);

  return publicUrl.publicUrl;
};
```

### 3. Enviar via API

```typescript
const sendFileMessage = async (fileUrl: string, fileName: string, fileType: string) => {
  const apiBaseUrl = await getApiBaseUrl();
  
  const response = await fetch(`${apiBaseUrl}/enviar-arquivo`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      session_id: selectedSessionId,
      numero_paciente: cleanPhone,
      file_url: fileUrl,
      file_name: fileName,
      file_type: fileType,
      nome_login: user.name,
    }),
  });

  return await response.json();
};
```

### 4. Preview Modal (Opcional)

```tsx
<Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Enviar arquivo</DialogTitle>
    </DialogHeader>
    <div className="space-y-4">
      {/* Preview da imagem ou √≠cone do arquivo */}
      {fileType.startsWith('image/') ? (
        <img src={filePreviewUrl} alt="Preview" className="max-w-full rounded" />
      ) : (
        <div className="flex items-center gap-2 p-4 border rounded">
          <FileText className="h-8 w-8" />
          <div>
            <div className="font-medium">{fileName}</div>
            <div className="text-sm text-muted-foreground">{fileSize}</div>
          </div>
        </div>
      )}
      
      {/* Input de legenda */}
      <Input
        placeholder="Adicionar legenda (opcional)"
        value={caption}
        onChange={(e) => setCaption(e.target.value)}
      />
    </div>
    <DialogFooter>
      <Button variant="outline" onClick={() => setPreviewOpen(false)}>
        Cancelar
      </Button>
      <Button onClick={handleSendFile}>
        <Send className="h-4 w-4 mr-2" />
        Enviar
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

---

## üöÄ Pr√≥ximos Passos - Implementa√ß√£o de √Åudio

### 1. Criar Estados de Grava√ß√£o

```tsx
const [isRecording, setIsRecording] = useState(false);
const [recordingTime, setRecordingTime] = useState(0);
const [audioBlob, setAudioBlob] = useState<Blob | null>(null);
const mediaRecorderRef = useRef<MediaRecorder | null>(null);
```

### 2. Iniciar Grava√ß√£o

```typescript
const handleRecordAudio = async () => {
  if (isRecording) {
    // Parar grava√ß√£o
    mediaRecorderRef.current?.stop();
    setIsRecording(false);
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    mediaRecorderRef.current = mediaRecorder;

    const chunks: BlobPart[] = [];
    
    mediaRecorder.ondataavailable = (e) => {
      chunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      setAudioBlob(blob);
      setIsRecording(false);
      
      // Abrir modal de preview
      setAudioPreviewOpen(true);
    };

    mediaRecorder.start();
    setIsRecording(true);
    
  } catch (error) {
    console.error('Erro ao acessar microfone:', error);
    toast.error('N√£o foi poss√≠vel acessar o microfone');
  }
};
```

### 3. Timer de Grava√ß√£o

```typescript
useEffect(() => {
  if (!isRecording) return;

  const interval = setInterval(() => {
    setRecordingTime((prev) => prev + 1);
  }, 1000);

  return () => clearInterval(interval);
}, [isRecording]);
```

### 4. Interface Durante Grava√ß√£o

```tsx
{isRecording ? (
  <div className="flex items-center gap-2 text-red-500">
    <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
    <span className="text-sm font-medium">
      {formatTime(recordingTime)}
    </span>
  </div>
) : null}
```

### 5. Upload e Envio

```typescript
const sendAudioMessage = async (audioBlob: Blob) => {
  // Converter blob para file
  const audioFile = new File([audioBlob], `audio_${Date.now()}.webm`, {
    type: 'audio/webm',
  });

  // Upload para Supabase
  const audioUrl = await uploadFile(audioFile);

  // Enviar via API
  const apiBaseUrl = await getApiBaseUrl();
  
  const response = await fetch(`${apiBaseUrl}/enviar-audio`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      session_id: selectedSessionId,
      numero_paciente: cleanPhone,
      audio_url: audioUrl,
      duration: recordingTime,
      nome_login: user.name,
    }),
  });

  return await response.json();
};
```

---

## üìä Endpoints de API Necess√°rios

### 1. POST /enviar-arquivo

**Request:**
```json
{
  "session_id": "uuid",
  "numero_paciente": "5511987654321",
  "file_url": "https://storage.supabase.co/...",
  "file_name": "documento.pdf",
  "file_type": "application/pdf",
  "caption": "Segue o exame solicitado",
  "nome_login": "Maria Silva"
}
```

**Response:**
```json
{
  "success": true,
  "message_id": "wamid.xxx",
  "status": "sent"
}
```

### 2. POST /enviar-audio

**Request:**
```json
{
  "session_id": "uuid",
  "numero_paciente": "5511987654321",
  "audio_url": "https://storage.supabase.co/...",
  "duration": 15,
  "nome_login": "Maria Silva"
}
```

**Response:**
```json
{
  "success": true,
  "message_id": "wamid.xxx",
  "status": "sent"
}
```

---

## üé® Melhorias de UX Futuras

### Bot√£o de Anexo

1. **Menu dropdown** ao inv√©s de abrir file picker direto:
   ```tsx
   <DropdownMenu>
     <DropdownMenuTrigger>
       <Button variant="ghost" size="icon">
         <Paperclip />
       </Button>
     </DropdownMenuTrigger>
     <DropdownMenuContent>
       <DropdownMenuItem onClick={handleAttachImage}>
         <Image className="mr-2 h-4 w-4" />
         Imagem
       </DropdownMenuItem>
       <DropdownMenuItem onClick={handleAttachDocument}>
         <FileText className="mr-2 h-4 w-4" />
         Documento
       </DropdownMenuItem>
     </DropdownMenuContent>
   </DropdownMenu>
   ```

2. **Drag & Drop:** Arrastar arquivo para a √°rea de mensagens

3. **Paste:** Colar imagem do clipboard (Ctrl+V)

### Bot√£o de √Åudio

1. **Segurar para gravar:** Padr√£o WhatsApp (hold-to-record)

2. **Cancelar grava√ß√£o:** Arrastar para esquerda

3. **Enviar r√°pido:** Soltar o bot√£o

4. **Bloqueio de grava√ß√£o:** Arrastar para cima para travar

---

## ‚úÖ Checklist de Implementa√ß√£o Futura

### Anexo de Arquivo

- [ ] Adicionar input file oculto
- [ ] Implementar sele√ß√£o de arquivo
- [ ] Validar tipo e tamanho do arquivo
- [ ] Criar preview modal
- [ ] Implementar upload para Supabase Storage
- [ ] Criar endpoint `/enviar-arquivo` no webhook
- [ ] Integrar com API de envio
- [ ] Adicionar progress bar de upload
- [ ] Implementar drag & drop
- [ ] Implementar paste de clipboard

### Grava√ß√£o de √Åudio

- [ ] Solicitar permiss√£o de microfone
- [ ] Implementar MediaRecorder
- [ ] Criar timer de grava√ß√£o
- [ ] Adicionar bot√£o de pausar/retomar
- [ ] Criar preview do √°udio gravado
- [ ] Implementar upload para Supabase Storage
- [ ] Criar endpoint `/enviar-audio` no webhook
- [ ] Integrar com API de envio
- [ ] Adicionar limite de dura√ß√£o (ex: 5 minutos)
- [ ] Implementar hold-to-record (segurar para gravar)

---

## üìù Arquivos Modificados

### `src/pages/WhatsApp.tsx`

**Linhas adicionadas:**

1. **Linha 14:** Import dos √≠cones `Paperclip` e `Mic`
2. **Linhas 518-530:** Handlers `handleAttachFile` e `handleRecordAudio`
3. **Linhas 757-820:** Nova interface da barra de mensagens com os bot√µes

**Total:** ~70 linhas adicionadas

---

## üéØ Resultado Visual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Conversa Selecionada                   ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  Mensagens...                                           ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  [üìé]  [Digite sua mensagem...]  [üé§]  [üì§]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Legenda:
üìé = Anexar arquivo/imagem (Paperclip)
üé§ = Gravar √°udio (Mic)
üì§ = Enviar mensagem (Send)
```

---

## üß™ Como Testar Agora

1. **Recarregue a p√°gina** (Ctrl+R)
2. **Selecione uma conversa**
3. **Veja os novos bot√µes** na barra inferior
4. **Passe o mouse** sobre cada bot√£o para ver o tooltip
5. **Clique no bot√£o de anexo (üìé)**
   - Ver√° toast: "Funcionalidade de anexo ser√° implementada em breve"
   - Console: `[WhatsApp] üìé Bot√£o de anexar arquivo clicado`
6. **Clique no bot√£o de √°udio (üé§)**
   - Ver√° toast: "Funcionalidade de √°udio ser√° implementada em breve"
   - Console: `[WhatsApp] üé§ Bot√£o de gravar √°udio clicado`

---

**Implementa√ß√£o visual conclu√≠da em:** 2025-10-11  
**Status:** ‚úÖ Interface pronta, l√≥gica a ser implementada  
**Pr√≥ximo passo:** Implementar upload e envio de arquivos/√°udio

